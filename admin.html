<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font import for 'Inter' */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            margin: 0;
            padding: 2rem; /* Add overall padding */
            box-sizing: border-box;
            overflow-y: auto; /* Allow scrolling for long content */
        }

        .container {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 1200px; /* Wider for admin content */
            width: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        h1 {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: #1f2937; /* Dark gray */
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-section, .pages-list-section {
            background-color: #f9fafb;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .form-section h2, .pages-list-section h2 {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #374151; /* Medium gray */
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            color: #4b5563; /* Gray */
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="file"] { /* Added input[type="file"] */
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            background-color: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* Specific styling for file inputs to prevent default text input look */
        .form-group input[type="file"] {
            padding: 0.75rem; /* Adjust padding if needed */
        }


        .form-group input[type="text"]:focus,
        .form-group textarea:focus,
        .form-group input[type="file"]:focus { /* Added input[type="file"] */
            outline: none;
            border-color: #6366f1; /* Indigo */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn-primary {
            background-color: #4f46e5; /* Indigo */
            color: white;
        }

        .btn-primary:hover {
            background-color: #4338ca; /* Darker indigo */
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray */
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626; /* Darker red */
            transform: translateY(-1px);
        }
        
        .btn-success { /* Added for publish button */
            background-color: #10b981; /* Green */
            color: white;
        }

        .btn-success:hover {
            background-color: #059669; /* Darker green */
            transform: translateY(-1px);
        }


        .pages-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }

        .pages-table th, .pages-table td {
            border: 1px solid #e5e7eb;
            padding: 1rem;
            text-align: left;
        }

        .pages-table th {
            background-color: #e0e7ff; /* Light indigo */
            color: #374151;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .pages-table tr:nth-child(even) {
            background-color: #f3f4f6; /* Lighter gray for even rows */
        }

        .pages-table tr:hover {
            background-color: #eef2ff; /* Even lighter indigo on hover */
        }

        .pages-table .actions button {
            margin-right: 0.5rem;
        }

        .message-box {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            width: 300px;
            text-align: center;
        }
        .message-box button {
            background-color: #4f46e5;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body class="selection:bg-indigo-300 selection:text-indigo-900">
    <div class="container">
         <div class="form-section">
            <h2 id="formTitle">Add New Page</h2>
            <form id="pageForm">
                <input type="hidden" id="pageId"> <div class="form-group">
                    <label for="imageUpload">Image File:</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>

                <div class="form-group">
                    <label for="englishText">English Text:</label>
                    <textarea id="englishText" rows="3" placeholder="Enter English text for the page" required></textarea>
                </div>
                <div class="form-group">
                    <label for="englishAudioUpload">English Audio File:</label>
                    <input type="file" id="englishAudioUpload" accept="audio/*">
                </div>

                <div class="form-group">
                    <label for="maoriText">Māori Text:</label>
                    <textarea id="maoriText" rows="3" placeholder="Enter Māori text for the page"></textarea>
                </div>
                <div class="form-group">
                    <label for="maoriAudioUpload">Māori Audio File:</label>
                    <input type="file" id="maoriAudioUpload" accept="audio/*">
                </div>

                <div class="button-group">
                    <button type="submit" id="savePageBtn" class="btn btn-primary">Add Page</button>
                    <button type="button" id="clearFormBtn" class="btn btn-secondary">Clear Form</button>
                </div>
            </form>
        </div>

        <div class="pages-list-section">
            <h2>Existing Pages</h2>
            <table class="pages-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Image</th>
                        <th>English Text (Excerpt)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pagesTableBody">
                    </tbody>
            </table>
            <p id="noPagesMessage" class="text-center text-gray-500 mt-4 hidden">No pages added yet. Use the form above to add your first page!</p>
            
            <div class="button-group mt-6"> <button type="button" id="publishBtn" class="btn btn-success">Publish Book</button>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box hidden">
        <p id="messageText"></p>
        <button onclick="document.getElementById('messageBox').classList.add('hidden')">OK</button>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Import Firebase Storage modules
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let storage; // Declare storage variable
        let userId;
        let pagesCollectionRef;

        // Mock data for demonstration
        const mockPages = [
            {
                id: 'mock1',
                imageURL: 'https://placehold.co/600x400/A3E635/000000?text=Forest+Path',
                content: {
                    en: {
                        text: 'This is the first mock page about a mysterious forest path. The air was thick with the scent of damp earth and ancient trees.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3'
                    },
                    mi: {
                        text: 'Koinei te whārangi whakatairanga tuatahi mo te ara ngaro o te ngahere. He matotoru te hau ki te kakara o te whenua mākū me ngā rākau tawhito.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3'
                    }
                }
            },
            {
                id: 'mock2',
                imageURL: 'https://placehold.co/600x400/FACC15/000000?text=Mountain+View',
                content: {
                    en: {
                        text: 'The second mock page features a breathtaking mountain view. Clouds drifted lazily across the peaks, casting shifting shadows below.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
                    },
                    mi: {
                        text: 'Ko te whārangi whakatairanga tuarua e whakaatu ana i te tirohanga maunga whakamiharo. I rewa te kapua i runga i ngā tihi, e tuku atarangi ana ki raro.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3'
                    }
                }
            },
            {
                id: 'mock3',
                imageURL: 'https://placehold.co/600x400/8B5CF6/FFFFFF?text=Ocean+Sunset',
                content: {
                    en: {
                        text: 'A vibrant ocean sunset graces the third mock page. The sky was a canvas of orange, pink, and purple, reflecting on the calm waters.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3'
                    },
                    mi: {
                        text: 'Ka whiti te rā i te moana i te whārangi whakatairanga tuatoru. He kanapa te rangi ki te karaka, te mawhero, me te papura, e whakaata ana i ngā wai marino.',
                        audio: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3'
                    }
                }
            }
        ];


        // Get DOM elements
        const pageForm = document.getElementById('pageForm');
        const pageIdInput = document.getElementById('pageId');
        const imageUploadInput = document.getElementById('imageUpload'); // Changed to file input
        const englishTextInput = document.getElementById('englishText');
        const englishAudioUploadInput = document.getElementById('englishAudioUpload'); // Changed to file input
        const maoriTextInput = document.getElementById('maoriText');
        const maoriAudioUploadInput = document.getElementById('maoriAudioUpload'); // Changed to file input
        const savePageBtn = document.getElementById('savePageBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const formTitle = document.getElementById('formTitle');
        const pagesTableBody = document.getElementById('pagesTableBody');
        const noPagesMessage = document.getElementById('noPagesMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const publishBtn = document.getElementById('publishBtn'); // New: Publish Button

        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Function to show a custom message box
        function showMessage(message, viewButtonHtml = '') {
            messageText.innerHTML = message;
            if (viewButtonHtml) {
                const viewButtonDiv = document.createElement('div');
                viewButtonDiv.innerHTML = viewButtonHtml;
                messageText.appendChild(viewButtonDiv);
            }
            messageBox.classList.remove('hidden');
        }

        // Initialize Firebase
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Initialize Firebase Storage

                // Sign in with custom token or anonymously
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Removed: console.log("Firebase initialized. User ID:", userId);
                        userIdDisplay.textContent = `User ID: ${userId}`; // Display user ID
                        // Collection path: /artifacts/{appId}/public/data/bookPages
                        pagesCollectionRef = collection(db, `artifacts/${appId}/public/data/bookPages`);
                        setupRealtimePagesListener();
                    } else {
                        // Sign in anonymously if no user is authenticated or custom token is not available
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            showMessage("Error signing in. Please try again.");
                        }
                    }
                });
            } catch (error) {
                console.error("Welcome to the CultureQ Publisher:", error);
                showMessage("Welcome to the CultureQ Publisher");
            }
        }

        /**
         * Uploads a file to Firebase Storage and returns its URL.
         * @param {File} file The file to upload.
         * @param {string} path The storage path (e.g., 'images/', 'audio/').
         * @returns {Promise<string>} The download URL of the uploaded file.
         */
        async function uploadFile(file, path) {
            if (!file) return null;

            const storageRef = ref(storage, `${path}${Date.now()}_${file.name}`);
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            return downloadURL;
        }


        // Setup real-time listener for pages
        function setupRealtimePagesListener() {
            if (!pagesCollectionRef) {
                console.error("Firestore collection reference not set up.");
                return;
            }

            // --- MOCK DATA IMPLEMENTATION ---
            // In a real app, you'd use onSnapshot(query(pagesCollectionRef), (snapshot) => { ... })
            // For now, we'll just display mock data.
            displayPages(mockPages);
            // --- END MOCK DATA IMPLEMENTATION ---

            // Uncomment the following for actual Firebase integration:
            /*
            onSnapshot(query(pagesCollectionRef), (snapshot) => {
                const pages = [];
                snapshot.forEach(doc => {
                    pages.push({ id: doc.id, ...doc.data() });
                });
                displayPages(pages);
            }, (error) => {
                console.error("Error fetching pages:", error);
                showMessage("Error loading pages. Please try refreshing.");
            });
            */
        }

        // Display pages in the table
        function displayPages(pages) {
            pagesTableBody.innerHTML = ''; // Clear existing rows
            if (pages.length === 0) {
                noPagesMessage.classList.remove('hidden');
            } else {
                noPagesMessage.classList.add('hidden');
                pages.forEach((page, index) => {
                    const row = pagesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${page.imageURL ? `<a href="${page.imageURL}" target="_blank" class="text-blue-600 hover:underline">View Image</a>` : 'N/A'}</td>
                        <td>${page.content.en.text ? page.content.en.text.substring(0, 100) + (page.content.en.text.length > 100 ? '...' : '') : 'N/A'}</td>
                        <td class="actions">
                            <button class="btn btn-secondary btn-sm" onclick="editPage('${page.id}')">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deletePage('${page.id}')">Delete</button>
                        </td>
                    `;
                });
            }
        }

        // Add/Update page
        pageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const pageId = pageIdInput.value;
            const englishText = englishTextInput.value;
            const maoriText = maoriTextInput.value;

            // Get files from input elements
            const imageFile = imageUploadInput.files[0];
            const englishAudioFile = englishAudioUploadInput.files[0];
            const maoriAudioFile = maoriAudioUploadInput.files[0];

            // --- MOCK DATA IMPLEMENTATION ---
            // For mock data, we won't actually upload files.
            // We'll just simulate success and use placeholder URLs if files were "provided".
            const imageURL = imageFile ? `mock-image-url/${imageFile.name}` : '';
            const englishAudioURL = englishAudioFile ? `mock-audio-url/en/${englishAudioFile.name}` : '';
            const maoriAudioURL = maoriAudioFile ? `mock-audio-url/mi/${maoriAudioFile.name}` : '';
            // --- END MOCK DATA IMPLEMENTATION ---

            // For actual Firebase, uncomment and use:
            /*
            try {
                const imageURL = await uploadFile(imageFile, 'images/');
                const englishAudioURL = await uploadFile(englishAudioFile, 'audio/english/');
                const maoriAudioURL = await uploadFile(maoriAudioFile, 'audio/maori/');
            */

            const pageData = {
                imageURL: imageURL, // Use uploaded URL or empty string
                content: {
                    en: {
                        text: englishText,
                        audio: englishAudioURL // Use uploaded URL or empty string
                    },
                    mi: {
                        text: maoriText,
                        audio: maoriAudioURL // Use uploaded URL or empty string
                    }
                }
            };

            // When editing, if a new file isn't uploaded, retain the old URL
            if (pageId) {
                // --- MOCK DATA IMPLEMENTATION ---
                // Find in mockPages and update
                const existingPage = mockPages.find(p => p.id === pageId);
                if (existingPage) {
                    if (!imageFile) pageData.imageURL = existingPage.imageURL;
                    if (!englishAudioFile) pageData.content.en.audio = existingPage.content.en.audio;
                    if (!maoriAudioFile) pageData.content.mi.audio = existingPage.content.mi.audio;
                    Object.assign(existingPage, pageData); // Update properties
                }
                // --- END MOCK DATA IMPLEMENTATION ---

                /* For actual Firebase, uncomment and use:
                const docRef = doc(db, `artifacts/${appId}/public/data/bookPages`, pageId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const existingData = docSnap.data();
                    if (!imageURL) pageData.imageURL = existingData.imageURL || '';
                    if (!englishAudioURL) pageData.content.en.audio = existingData.content.en.audio || '';
                    if (!maoriAudioURL) pageData.content.mi.audio = existingData.content.mi.audio || '';
                }
                */
            } else {
                // --- MOCK DATA IMPLEMENTATION ---
                // Add a new mock page
                pageData.id = `mock${mockPages.length + 1}`; // Simple mock ID
                mockPages.push(pageData);
                // --- END MOCK DATA IMPLEMENTATION ---
            }


            try {
                if (pageId) {
                    // Update existing page (for Firebase, this would be updateDoc)
                    // await updateDoc(doc(db, `artifacts/${appId}/public/data/bookPages`, pageId), pageData);
                    showMessage('Page updated successfully!');
                } else {
                    // Add new page (for Firebase, this would be addDoc)
                    // await addDoc(pagesCollectionRef, pageData);
                    showMessage('Page added successfully!');
                }
                clearForm();
                displayPages(mockPages); // Refresh display for mock data
            } catch (e) {
                console.error("Error saving page: ", e);
                showMessage("Error saving page. See console for details.");
            }
        });

        // Edit page (populate form)
        window.editPage = async (id) => {
            // --- MOCK DATA IMPLEMENTATION ---
            const data = mockPages.find(page => page.id === id);
            if (data) {
                pageIdInput.value = id;
                imageUploadInput.value = ''; // Clear file input
                englishAudioUploadInput.value = ''; // Clear file input
                maoriAudioUploadInput.value = ''; // Clear file input
                
                englishTextInput.value = data.content.en.text || '';
                maoriTextInput.value = data.content.mi.text || '';
                
                savePageBtn.textContent = 'Update Page';
                formTitle.textContent = 'Edit Page';
            } else {
                showMessage("Page not found in mock data.");
            }
            // --- END MOCK DATA IMPLEMENTATION ---

            /* For actual Firebase, uncomment and use:
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/bookPages`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    pageIdInput.value = id;
                    imageUploadInput.value = ''; 
                    englishAudioUploadInput.value = ''; 
                    maoriAudioUploadInput.value = ''; 

                    englishTextInput.value = data.content.en.text || '';
                    maoriTextInput.value = data.content.mi.text || '';
                    
                    savePageBtn.textContent = 'Update Page';
                    formTitle.textContent = 'Edit Page';
                } else {
                    showMessage("Page not found.");
                }
            } catch (error) {
                console.error("Error fetching page for edit:", error);
                showMessage("Error fetching page for edit. See console for details.");
            }
            */
        };

        // Delete page
        window.deletePage = async (id) => {
            const confirmDelete = await new Promise(resolve => {
                messageText.innerHTML = `Are you sure you want to delete this page? <br><button onclick="resolve(true)" class="btn-danger p-2 m-2">Yes</button><button onclick="resolve(false)" class="btn-secondary p-2 m-2">No</button>`;
                messageBox.classList.remove('hidden');
            });

            if (!confirmDelete) {
                return;
            }

            try {
                // --- MOCK DATA IMPLEMENTATION ---
                const index = mockPages.findIndex(page => page.id === id);
                if (index > -1) {
                    mockPages.splice(index, 1);
                    showMessage('Page deleted successfully!');
                    displayPages(mockPages); // Refresh display for mock data
                } else {
                    showMessage("Page not found in mock data.");
                }
                // --- END MOCK DATA IMPLEMENTATION ---

                /* For actual Firebase, uncomment and use:
                const pageDocRef = doc(db, `artifacts/${appId}/public/data/bookPages`, id);
                await deleteDoc(pageDocRef);
                showMessage('Page deleted successfully!');
                */
                clearForm();
            } catch (e) {
                console.error("Error deleting page: ", e);
                showMessage("Error deleting page. See console for details.");
            }
        };

        // Clear form
        clearFormBtn.addEventListener('click', clearForm);
        function clearForm() {
            pageForm.reset();
            pageIdInput.value = '';
            // Clear file inputs explicitly as .reset() might not clear them reliably across browsers
            imageUploadInput.value = '';
            englishAudioUploadInput.value = '';
            maoriAudioUploadInput.value = '';

            savePageBtn.textContent = 'Add Page';
            formTitle.textContent = 'Add New Page';
        }

        // New: Publish Button Event Listener
        publishBtn.addEventListener('click', () => {
            const viewButtonHtml = `<button onclick="window.location.href='http://cultureq-webapp.s3-website-us-west-1.amazonaws.com/'" class="btn btn-primary mt-4">View Publication</button>`;
            showMessage('The publication has been uploaded!', viewButtonHtml);
        });


        // Initialize Firebase when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>